<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canvas Chart</title>
</head>
<body style="background-color: black; margin:0; padding:0;">
<canvas id="canvas" style="background-color: grey; width:100vw; height:100vh;"></canvas>

<script>
const data = [
{"x":1755820800,"y":116935.99},
{"x":1755907200,"y":115438.05},
{"x":1755993600,"y":113493.59},
{"x":1756080000,"y":110111.98},
{"x":1756166400,"y":111763.22},
{"x":1756252800,"y":111262.01},
{"x":1756339200,"y":112566.9},
{"x":1756425600,"y":108377.4},
{"x":1756512000,"y":108816.33},
{"x":1756598400,"y":108246.35},
{"x":1756684800,"y":109237.42},
{"x":1756771200,"y":111240.01},
{"x":1756857600,"y":111705.71},
{"x":1756944000,"y":110730.87},
{"x":1757030400,"y":110659.99},
{"x":1757116800,"y":110187.97},
{"x":1757203200,"y":111137.34},
{"x":1757289600,"y":112065.23},
{"x":1757376000,"y":111546.39},
{"x":1757462400,"y":113960},
{"x":1757548800,"y":115482.69},
{"x":1757635200,"y":116029.42},
{"x":1757721600,"y":115918.29},
{"x":1757808000,"y":115268.01},
{"x":1757894400,"y":115349.71},
{"x":1757980800,"y":116788.96},
{"x":1758067200,"y":116447.59},
{"x":1758153600,"y":117073.53},
{"x":1758240000,"y":115632.38},
{"x":1758326400,"y":115685.63},
{"x":1758412800,"y":115232.29},
{"x":1758499200,"y":112650.99},
{"x":1758585600,"y":111998.8},
{"x":1758672000,"y":113307},
{"x":1758758400,"y":108994.49},
{"x":1758844800,"y":109643.46},
{"x":1758931200,"y":109635.85},
{"x":1759017600,"y":112163.95},
{"x":1759104000,"y":114311.96},
{"x":1759190400,"y":114048.93},
{"x":1759276800,"y":118594.99},
{"x":1759363200,"y":120529.35},
{"x":1759449600,"y":122232},
{"x":1759536000,"y":122391},
{"x":1759622400,"y":123482.31},
{"x":1759708800,"y":124658.54},
{"x":1759795200,"y":121332.95},
{"x":1759881600,"y":123306},
{"x":1759968000,"y":121662.4},
{"x":1760054400,"y":112774.5},
{"x":1760140800,"y":110644.4},
{"x":1760227200,"y":114958.8},
{"x":1760313600,"y":115166},
{"x":1760400000,"y":113028.14},
{"x":1760486400,"y":110763.28},
{"x":1760572800,"y":108194.28},
{"x":1760659200,"y":106431.68},
{"x":1760745600,"y":107185.01},
{"x":1760832000,"y":108642.78},
{"x":1760918400,"y":110532.09},
{"x":1761004800,"y":108297.67},
{"x":1761091200,"y":107567.44},
{"x":1761177600,"y":110078.18},
{"x":1761264000,"y":111004.89},
{"x":1761350400,"y":111646.27},
{"x":1761436800,"y":114559.4},
{"x":1761523200,"y":114107.65},
{"x":1761609600,"y":112898.45},
{"x":1761696000,"y":110021.29},
{"x":1761782400,"y":108322.88},
{"x":1761868800,"y":109608.01},
{"x":1761955200,"y":110098.1},
{"x":1762041600,"y":110540.68},
{"x":1762128000,"y":106583.04},
{"x":1762214400,"y":101497.22},
{"x":1762300800,"y":103885.16},
{"x":1762387200,"y":101346.04},
{"x":1762473600,"y":103339.08},
{"x":1762560000,"y":102312.94},
{"x":1762646400,"y":104722.96},
{"x":1762732800,"y":106011.13},
{"x":1762819200,"y":103058.99},
{"x":1762905600,"y":101654.37},
{"x":1762992000,"y":99692.02},
{"x":1763078400,"y":94594},
{"x":1763164800,"y":95596.24},
{"x":1763251200,"y":94261.44},
{"x":1763337600,"y":92215.14},
{"x":1763424000,"y":92960.83},
{"x":1763510400,"y":91554.96},
{"x":1763596800,"y":86637.23},
{"x":1763683200,"y":85129.43},
{"x":1763769600,"y":84739.74},
{"x":1763856000,"y":86830},
{"x":1763942400,"y":88300.01},
{"x":1764028800,"y":87369.96},
{"x":1764115200,"y":90484.02},
{"x":1764201600,"y":91333.95},
{"x":1764288000,"y":90890.7},
{"x":1764374400,"y":91026.3}
];

// ---------------- GLOBAL VARIABLES ----------------
const canvas = document.getElementById("canvas");

const MIN_PIX_PER_TICK = 50;
//to make the thicks more human readable
const NICE_STEPS = [1,2,5,10,20,50,100,200,500,1000,2000,5000,10000,50000,100000,500000,1000000,5000000,10000000];

//mobile touch constants
const ZOOM_IN_LIMIT_X = 0.1;   // minimum range (yakınlaştırma sınırı)
const ZOOM_IN_LIMIT_Y = 0.1;
const ZOOM_OUT_LIMIT_X = 500;   // maximum range (uzaklaştırma sınırı)
const ZOOM_OUT_LIMIT_Y = 500;

let ctx = canvas.getContext("2d"); //canvas context
let rect; //canvas area

//map the data
const xVals = data.map(d => d.x);
const yVals = data.map(d => d.y);

let minXValue = Math.min(...xVals);
let maxXValue = Math.max(...xVals);
let minYValue = Math.min(...yVals);
let maxYValue = Math.max(...yVals);

//to reset to original pos
const origMinX = Math.min(...xVals);
const origMaxX = Math.max(...xVals);
const origMinY = Math.min(...yVals);
const origMaxY = Math.max(...yVals);

let axisPadding = { left: 30, bottom: 30, right:10, top: 10};
axisPadding.left = ctx.measureText(maxYValue.toString()).width;

//usableWidth = canvas.width - axisPadding.left....
let usableWidth, usableHeight; 
let maxTickCount; //(usableWidth / MIN_PIX_PER_TICK)

//pan and zoom variables
let isDragging = false;
let dragStart = { x: 0, y: 0 };
let panOffset = { x: 0, y: 0 };
let lastPinchDist = 0;

// ---------------- HELPER ----------------
function getNiceStep(n) {
    for (let i of NICE_STEPS) if (n <= i) return i;
    return NICE_STEPS[NICE_STEPS.length - 1];
}

// ---------------- AXIS DRAWING ----------------
function drawAxisLines() {
    //draw y axis
    ctx.beginPath();
    ctx.moveTo(axisPadding.left, 0);
    ctx.lineTo(axisPadding.left, usableHeight);
    ctx.stroke();
    //draw x axis
    ctx.beginPath();
    ctx.moveTo(axisPadding.left, usableHeight);
    ctx.lineTo(canvas.width, usableHeight);
    ctx.stroke();
}

function drawXAxisLabels() {
    const range = maxXValue - minXValue;
    const roughStep = Math.floor(range / maxTickCount);
    const niceStep = getNiceStep(roughStep);

    const xStart = Math.floor(minXValue / niceStep) * niceStep;
    const xEnd = Math.ceil(maxXValue / niceStep) * niceStep;

    for (let i = xStart; i <= xEnd; i += niceStep) {
        const pos = ((i - minXValue) / range) * usableWidth;
        ctx.fillText(i, axisPadding.left + pos - 5, usableHeight + 15);
    }
}

function drawYAxisLabels() {
    const range = maxYValue - minYValue;
    const roughStep = Math.floor(range / maxTickCount);
    const niceStep = getNiceStep(roughStep);

    const yStart = Math.floor(minYValue / niceStep) * niceStep;
    const yEnd = Math.ceil(maxYValue / niceStep) * niceStep;

    for (let i = yStart; i <= yEnd; i += niceStep) {
        if (i === yStart) continue;

        const pos = usableHeight - ((i - minYValue) / range) * usableHeight;

        ctx.fillText(i, 5, pos + 3);
    }
}

// ---------------- LİNE DRAWING ----------------
function drawLineSeries() {
    const rangeX = maxXValue - minXValue;
    const rangeY = maxYValue - minYValue;

    for (let i = 0; i < data.length - 1; i++) {
        let x1 = ((data[i].x - minXValue) / rangeX) * usableWidth + axisPadding.left;
        let y1 = usableHeight - ((data[i].y - minYValue) / rangeY) * usableHeight;

        let x2 = ((data[i+1].x - minXValue) / rangeX) * usableWidth + axisPadding.left;
        let y2 = usableHeight - ((data[i+1].y - minYValue) / rangeY) * usableHeight;

        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    }
}

// ---------------- MAIN DRAWING ----------------
function draw() {
    rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;

    ctx = canvas.getContext("2d");
    ctx.font = "12px Arial";

    usableWidth = canvas.width - axisPadding.left - axisPadding.right;
    usableHeight = canvas.height - axisPadding.bottom - axisPadding.top;

    maxTickCount = Math.floor(usableWidth / MIN_PIX_PER_TICK);

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawAxisLines();
    drawXAxisLabels();
    drawYAxisLabels();

    ctx.save(); // Mevcut Canvas durumunu kaydet
    ctx.beginPath();
    ctx.rect(
        axisPadding.left,
        axisPadding.top,
        usableWidth,
        usableHeight - axisPadding.top
    );
    ctx.clip(); // Bu yolu kırpma yolu olarak ayarla

    drawLineSeries();
    ctx.restore();
}

draw();

function resetView() {
    minXValue = origMinX;
    maxXValue = origMaxX;
    minYValue = origMinY;
    maxYValue = origMaxY;
    draw();
}

canvas.addEventListener("dblclick", resetView);

// ---------------- RESIZE HELPER ----------------
let rTimer;
window.addEventListener("resize", () => {
    clearTimeout(rTimer);
    rTimer = setTimeout(draw, 120);
});

//touch functions
function getTouchDistance(t1, t2) {
    return Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
}

function getTouchCenter(t1, t2, rect) {
    return {
        x: ((t1.clientX + t2.clientX) / 2) - rect.left,
        y: ((t1.clientY + t2.clientY) / 2) - rect.top
    };
}

//mobile devices pan
canvas.addEventListener("touchstart", e => {
    if (e.touches.length === 1) {
        isDragging = true;

        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];

        dragStart = { 
            x: t.clientX - rect.left,
            y: t.clientY - rect.top
        };
    }

    if (e.touches.length === 2) {
        lastPinchDist = getTouchDistance(e.touches[0], e.touches[1]);
    }
});

canvas.addEventListener("touchmove", e => {
    const rect = canvas.getBoundingClientRect();

    // ----- PINCH ZOOM -----
    if (e.touches.length === 2) {
        e.preventDefault();

        const t1 = e.touches[0];
        const t2 = e.touches[1];

        const newDist = getTouchDistance(t1, t2);

        if (newDist < 10) {  // çok yakınsa
            resetView();
            return;
        }

        const zoomFactor = lastPinchDist / newDist;
        lastPinchDist = newDist;

        // --- Pinch merkezini al ---
        const center = getTouchCenter(t1, t2, rect);

        // Canvas içindeki oranlar
        const ratioX = (center.x - axisPadding.left) / usableWidth;
        const ratioY = (center.y) / usableHeight;

        const rangeX = maxXValue - minXValue;
        const rangeY = maxYValue - minYValue;

        const newRangeX = rangeX * zoomFactor;
        const newRangeY = rangeY * zoomFactor;

        //if (newRangeX < ZOOM_IN_LIMIT_X || newRangeX > ZOOM_OUT_LIMIT_X) return;
        //if (newRangeY < ZOOM_IN_LIMIT_Y || newRangeY > ZOOM_OUT_LIMIT_Y) return;

        // --- Pinch merkezini sabit tut ---
        minXValue = minXValue + rangeX * ratioX - newRangeX * ratioX;
        maxXValue = minXValue + newRangeX;

        minYValue = minYValue + rangeY * (1 - ratioY) - newRangeY * (1 - ratioY);
        maxYValue = minYValue + newRangeY;

        draw();
        return;
    }

    // ----- PAN (TEK PARMAK) -----
    if (e.touches.length === 1 && isDragging) {
        e.preventDefault();

        const t = e.touches[0];
        const mouseX = t.clientX - rect.left;
        const mouseY = t.clientY - rect.top;

        const dx = mouseX - dragStart.x;
        const dy = mouseY - dragStart.y;

        const rangeX = maxXValue - minXValue;
        const rangeY = maxYValue - minYValue;

        const xPerPixel = rangeX / usableWidth;
        const yPerPixel = rangeY / usableHeight;

        minXValue -= dx * xPerPixel;
        maxXValue -= dx * xPerPixel;

        minYValue += dy * yPerPixel;
        maxYValue += dy * yPerPixel;

        dragStart = { x: mouseX, y: mouseY };

        draw();
    }
});


canvas.addEventListener("touchend", () => isDragging = false);
canvas.addEventListener("touchcancel", () => isDragging = false);

canvas.addEventListener("mousedown", e => {
    isDragging = true;

    const rect = canvas.getBoundingClientRect();
    dragStart = { 
        x: e.clientX - rect.left, 
        y: e.clientY - rect.top 
    };
});

canvas.addEventListener("mousemove", e => {
    if (!isDragging) return;

    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    const dx = mouseX - dragStart.x;
    const dy = mouseY - dragStart.y;

    const rangeX = maxXValue - minXValue;
    const rangeY = maxYValue - minYValue;

    const xPerPixel = rangeX / usableWidth;
    const yPerPixel = rangeY / usableHeight;

    minXValue -= dx * xPerPixel;
    maxXValue -= dx * xPerPixel;
    minYValue += dy * yPerPixel;
    maxYValue += dy * yPerPixel;

    dragStart = { x: mouseX, y: mouseY };
    draw();
});

canvas.addEventListener("mouseup", () => isDragging = false);
canvas.addEventListener("mouseleave", () => isDragging = false);

canvas.addEventListener("wheel", e => {
    e.preventDefault(); // sayfanın kaymasını engelle

    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    // Fare konumunu oran olarak al
    const zoomX = (mouseX - axisPadding.left) / usableWidth;
    const zoomY = (mouseY) / usableHeight;

    const zoomFactor = e.deltaY < 0 ? 0.9 : 1.1; // yukarı scroll = zoom in, aşağı = zoom out

    const rangeX = maxXValue - minXValue;
    const rangeY = maxYValue - minYValue;

    const newRangeX = rangeX * zoomFactor;
    const newRangeY = rangeY * zoomFactor;

    //if (newRangeX < ZOOM_IN_LIMIT_X || newRangeX > ZOOM_OUT_LIMIT_X) return;
    //if (newRangeY < ZOOM_IN_LIMIT_Y || newRangeY > ZOOM_OUT_LIMIT_Y) return;

    // Fare noktasını sabit tutarak min/max değerleri ayarla
    minXValue = minXValue + rangeX * zoomX - newRangeX * zoomX;
    maxXValue = minXValue + newRangeX;

    minYValue = minYValue + rangeY * (1 - zoomY) - newRangeY * (1 - zoomY);
    maxYValue = minYValue + newRangeY;

    draw();
});


</script>
</body>
</html>
